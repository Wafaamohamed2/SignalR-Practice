<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SignalR Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .input-group {
            margin-bottom: 10px;
        }

        input[type="text"], input[type="password"] {
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 150px;
        }

        input[type="button"] {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

            input[type="button"]:hover {
                background-color: #0056b3;
            }

        #messageList {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            list-style-type: none;
            margin: 20px 0;
        }

            #messageList li {
                margin-bottom: 5px;
                padding: 5px;
                background-color: #f8f9fa;
                border-radius: 4px;
            }

        .notification {
            color: #28a745;
            font-style: italic;
        }

        .error {
            color: #dc3545;
            font-weight: bold;
        }

        .connection-status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>SignalR Chat Application</h1>

    <div id="connectionStatus" class="connection-status disconnected">Disconnected</div>

    <!-- Login -->
    <div class="input-group">
        <input type="text" id="loginUsername" placeholder="Username" />
        <input type="password" id="loginPassword" placeholder="Password" />
        <input type="button" id="loginButton" value="Login" />
    </div>

    <div class="input-group">
        Current User: <span id="currentUser">Not set</span>
    </div>

    <!-- Messages -->
    <div class="input-group">
        <input type="text" id="messageInput" placeholder="Type your message" />
        <input type="button" id="sendButton" value="Send Message" disabled />
    </div>

    <!-- Groups -->
    <div class="input-group">
        <input type="text" id="gtxt" placeholder="Group name" />
        <input type="button" id="joinButton" value="Join Group" disabled />
        <input type="button" id="sendGroupButton" value="Send to Group" disabled />
    </div>

    <!-- Notifications -->
    <div class="input-group">
        <input type="button" id="testNotificationButton" value="Test Notification" disabled />
    </div>

    <ul id="messageList"></ul>
    <script>
        let connection;
        let currentUserId = null;
        let currentUserName = null;
        let isConnected = false;
        let token = localStorage.getItem("jwtToken");

        // DOM elements
        const loginUsername = document.getElementById("loginUsername");
        const loginPassword = document.getElementById("loginPassword");
        const loginButton = document.getElementById("loginButton");
        const userInput = document.getElementById("userInput");
        const messageInput = document.getElementById("messageInput");
        const sendButton = document.getElementById("sendButton");
        const joinButton = document.getElementById("joinButton");
        const sendGroupButton = document.getElementById("sendGroupButton");
        const testNotificationButton = document.getElementById("testNotificationButton");
        const messageList = document.getElementById("messageList");
        const connectionStatus = document.getElementById("connectionStatus");
        const currentUserSpan = document.getElementById("currentUser");
        const groupInput = document.getElementById("gtxt");

        // ✅ Initialize SignalR connection
        async function initializeConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/chatHub", {
                    accessTokenFactory: () => token
                })
                .withAutomaticReconnect()
                .build();

            // Receive normal message
            connection.on("ReceiveMessage", (name, message) => {
                addMessageToList(`💬 ${name}: ${message}`);
            });

            connection.on("ReceiveGroupMessage", (name, group, message) => {
                addMessageToList(`👥 [${group}] ${name}: ${message}`);
            });
            // Receive notification
            connection.on("ReceiveNotification", (title, message) => {
                addMessageToList(`🔔 ${title}: ${message}`, "notification");
            });

            connection.onclose(() => {
                updateConnectionStatus(false);
                addMessageToList("❌ Connection lost", "error");
            });

            connection.onreconnecting(() => {
                updateConnectionStatus(false);
                addMessageToList("🔄 Reconnecting...", "notification");
            });

            connection.onreconnected(() => {
                updateConnectionStatus(true);
                addMessageToList("✅ Reconnected", "notification");
            });

            await connection.start();
            console.log("Connected with ID:", connection.connectionId);

            updateConnectionStatus(true);
        }

        // ✅ Update connection status
        function updateConnectionStatus(connected) {
            isConnected = connected;
            connectionStatus.textContent = connected ? "Connected" : "Disconnected";
            connectionStatus.className = `connection-status ${connected ? "connected" : "disconnected"}`;
            sendButton.disabled = !connected;
            joinButton.disabled = !connected;
            sendGroupButton.disabled = !connected;
            testNotificationButton.disabled = !connected;
        }

        // ✅ Send a direct message
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            connection.invoke("SendMessage", message)
                .then(() => { messageInput.value = ""; })
                .catch(err => {
                    console.error("SendMessage failed:", err);
                    addMessageToList("❌ Failed to send: " + err.message, "error");
                });
        }

        // ✅ Test notification via API
        async function testNotification() {
            if (!currentUserId) {
                alert("Please login first");
                return;
            }

            try {
                const response = await fetch("/api/Notifications/SendNotification", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userId: currentUserId,
                        title: "Test Notification",
                        notification: "This is a test notification!"
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    addMessageToList("📤 " + data.message, "notification");
                } else {
                    addMessageToList("❌ " + data.message, "error");
                }
            } catch (err) {
                console.error("Test notification error:", err);
                addMessageToList("❌ Failed to send notification", "error");
            }
        }

        // ✅ Add message to UI
        function addMessageToList(message, cssClass = "") {
            const li = document.createElement("li");
            li.textContent = message;
            if (cssClass) li.className = cssClass;
            messageList.appendChild(li);
            messageList.scrollTop = messageList.scrollHeight;
        }

        // ✅ Login
        loginButton.addEventListener("click", async () => {
            const username = loginUsername.value.trim();
            const password = loginPassword.value.trim();

            if (!username || !password) {
                alert("Enter username and password");
                return;
            }

            try {
                const response = await fetch("/api/Auth/Login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password })
                });

                // دايمًا استقبل JSON، حتى لو فيه Error
                const result = await response.json();

                if (!response.ok || !result.token) {
                    alert("Login failed: " + (result.message || response.statusText));
                    return;
                }

                // حفظ الـ token
                token = result.token;
                localStorage.setItem("jwtToken", token);
                currentUserId = username;
                currentUserSpan.textContent = username;

                // Connect to SignalR
                await initializeConnection();

                addMessageToList("✅ Login and connection successful", "notification");

            } catch (err) {
                console.error("Login error: ", err);
                alert("Login request failed: " + err.message);
            }
        });

        // Events
        sendButton.addEventListener("click", sendMessage);
        messageInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && isConnected) sendMessage();
        });

        joinButton.addEventListener("click", async () => {
            const groupName = groupInput.value.trim();
            if (!groupName) {
                alert("Please enter a group name");
                groupInput.focus();
                return;
            }

            try {
                const response = await fetch("/api/Groups/Join", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({ groupName })
                });

                const data = await response.json();

                if (response.ok) {
                    addMessageToList("✅ " + data.message, "notification");
                } else {

                    addMessageToList("⚠️ " + data.message, "notification");
                }
            } catch (err) {
                console.error("JoinGroup API failed: ", err);
                addMessageToList("❌ Request failed", "error");
            }
        });

        sendGroupButton.addEventListener("click", async () => {
            const groupName = groupInput.value.trim();
            const message = messageInput.value.trim();

            if (!groupName || !message) {
                alert("Please enter a group name and a message");
                return;
            }

            try {
                const response = await fetch("/api/Messages/SendToGroup", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        groupName: groupName,
                        message: message
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    addMessageToList("📤 " + data.message, "notification");
                    messageInput.value = "";
                } else {
                    addMessageToList("❌ Failed: " + data.message, "error");
                }
            } catch (err) {
                console.error("SendToGroup API failed: ", err);
                addMessageToList("❌ Request failed", "error");
            }
        });


        testNotificationButton.addEventListener("click", testNotification);

        // On page load
        window.addEventListener("load", () => {
            updateConnectionStatus(false);
        });
    </script>

</body>
</html>
