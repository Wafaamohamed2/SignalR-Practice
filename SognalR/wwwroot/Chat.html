<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SignalR Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .input-group {
            margin-bottom: 10px;
        }

        input[type="text"] {
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 150px;
        }

        input[type="button"] {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

            input[type="button"]:hover {
                background-color: #0056b3;
            }

        #messageList {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            list-style-type: none;
            margin: 20px 0;
        }

            #messageList li {
                margin-bottom: 5px;
                padding: 5px;
                background-color: #f8f9fa;
                border-radius: 4px;
            }

        .notification {
            color: #28a745;
            font-style: italic;
        }

        .error {
            color: #dc3545;
            font-weight: bold;
        }

        .connection-status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>SignalR Chat Application</h1>

    <div id="connectionStatus" class="connection-status disconnected">
        Disconnected
    </div>

    <div class="input-group">
        <input type="text" id="userInput" placeholder="Enter your name" />
        <span>Current User: <span id="currentUser">Not set</span></span>
    </div>

    <div class="input-group">
        <input type="text" id="messageInput" placeholder="Type your message" />
        <input type="button" id="sendButton" value="Send Message" disabled />
    </div>

    <div class="input-group">
        <input type="text" id="gtxt" placeholder="Group name" />
        <input type="button" id="joinButton" value="Join Group" disabled />
        <input type="button" id="sendGroupButton" value="Send to Group" disabled />
    </div>


    <ul id="messageList"></ul>

    <script>

        let connection;
        let currentUserId = null;
        let isConnected = false;


        // DOM elements
        const userInput = document.getElementById("userInput");
        const messageInput = document.getElementById("messageInput");
        const sendButton = document.getElementById("sendButton");
        const joinButton = document.getElementById("joinButton");
        const sendGroupButton = document.getElementById("sendGroupButton");
        const messageList = document.getElementById("messageList");
        const connectionStatus = document.getElementById("connectionStatus");
        const currentUserSpan = document.getElementById("currentUser");
        const groupInput = document.getElementById("gtxt");


        //1. Initialize  connection
        function initializeConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/chatHub")
                .withAutomaticReconnect()
                .build();


            connection.on("ReceiveMessage", (name, message) => {
                addMessageToList(`${name}: ${message}`);
            });

            connection.on("ShowWhoJoin", (name, gName) => {
                addMessageToList(`🔔 ${name} joined group (${gName})`, "notification");
            });

            connection.on("ReceiveGroupMessage", (name, gName, message) => {
                addMessageToList(`[${gName}] ${name}: ${message}`);
            });

            connection.onclose(() => {
                updateConnectionStatus(false);
                addMessageToList("❌ Connection lost", "error");
            });

            connection.onreconnecting(() => {
                updateConnectionStatus(false);
                addMessageToList("🔄 Reconnecting...", "notification");
            });

            connection.onreconnected(() => {
                updateConnectionStatus(true);
                addMessageToList("✅ Reconnected", "notification");
                if (currentUserId) {
                    registerUser(currentUserId);
                }
            });

        }

        // Start Connection
        function startConnection() {
            const userName = userInput.value.trim();
            if (!userName) {
                alert("Please enter your name first");
                userInput.focus();
                return;
            }

            currentUserId = userName;
            currentUserSpan.textContent = userName;

            connection.start()
                .then(() => {
                    updateConnectionStatus(true);
                    addMessageToList("✅ Connected to the chat server", "notification");
                    return registerUser(currentUserId);
                })
                .catch(err => {
                    console.error(err.toString());
                    addMessageToList("❌ Connection failed", "error");
                    updateConnectionStatus(false);
                });
        }

        // Register user with server
        function registerUser(userId) {
            if (connection && isConnected) {
                return connection.invoke("RegisterUser", userId)
                    .catch(err => {
                        console.error("RegisterUser failed: ", err);
                        addMessageToList("❌ Registration failed: " + err.message, "error");
                    });
            }
        }

        // Update connection status UI
        function updateConnectionStatus(connected) {
            isConnected = connected;
            connectionStatus.textContent = connected ? "Connected" : "Disconnected";
            connectionStatus.className = `connection-status ${connected ? "connected" : "disconnected"}`;

            // Enable/disable buttons based on connection status
            sendButton.disabled = !connected;
            joinButton.disabled = !connected;
            sendGroupButton.disabled = !connected;
        }
       
        // Add message to the list
        function addMessageToList(message, cssClass = "") {
            const li = document.createElement("li");
            li.textContent = message;
            if (cssClass) {
                li.className = cssClass;
            }
            messageList.appendChild(li);
            messageList.scrollTop = messageList.scrollHeight;
        }

        userInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !isConnected) {
                startConnection();
            }
        });

        userInput.addEventListener("blur", () => {
            if (!isConnected && userInput.value.trim()) {
                startConnection();
            }
        });

        messageInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && isConnected) {
                sendMessage();
            }
        });

        sendButton.addEventListener("click", sendMessage);

        joinButton.addEventListener("click", () => {
            const groupName = groupInput.value.trim();
            const userName = currentUserId;

            if (!groupName) {
                alert("Please enter a group name");
                groupInput.focus();
                return;
            }

            if (!userName) {
                alert("Please set your name first");
                return;
            }

            connection.invoke("JoinGroup", groupName, userName)
                .then(() => {
                    addMessageToList(`📝 You joined group: ${groupName}`, "notification");
                })
                .catch(err => {
                    console.error("JoinGroup failed: ", err);
                    addMessageToList("❌ Failed to join group: " + err.message, "error");
                });
        });

        sendGroupButton.addEventListener("click", () => {
            const groupName = groupInput.value.trim();
            const message = messageInput.value.trim();
            const userName = currentUserId;

            if (!groupName) {
                alert("Please enter a group name");
                groupInput.focus();
                return;
            }

            if (!message) {
                alert("Please enter a message");
                messageInput.focus();
                return;
            }

            if (!userName) {
                alert("Please set your name first");
                return;
            }

            connection.invoke("SendMessageToGroup", groupName, userName, message)
                .then(() => {
                    messageInput.value = "";
                })
                .catch(err => {
                    console.error("SendMessageToGroup failed: ", err);
                    addMessageToList("❌ Failed to send group message: " + err.message, "error");
                });
        });

        function sendMessage() {
            const message = messageInput.value.trim();
            const userName = currentUserId;

            if (!message) {
                alert("Please enter a message");
                messageInput.focus();
                return;
            }

            if (!userName) {
                alert("Please set your name first");
                return;
            }

            connection.invoke("SendMessage", userName, message)
                .then(() => {
                    messageInput.value = "";
                })
                .catch(err => {
                    console.error("SendMessage failed: ", err);
                    addMessageToList("❌ Failed to send message: " + err.message, "error");
                });
        }

        // Initialize when page loads
        window.addEventListener("load", () => {
            initializeConnection();
            updateConnectionStatus(false);

            // Try to get stored user info
            const storedUserId = sessionStorage.getItem("userId");
            if (storedUserId) {
                userInput.value = storedUserId;
                currentUserSpan.textContent = storedUserId;
            }

            userInput.focus();
        });

        // Save user info when page unloads
        window.addEventListener("beforeunload", () => {
            if (currentUserId) {
                sessionStorage.setItem("userId", currentUserId);
            }
        });

    </script>
</body>
</html>