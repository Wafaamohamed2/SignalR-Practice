<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SignalR Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .input-group {
            margin-bottom: 10px;
        }

        input[type="text"], input[type="password"] {
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 150px;
        }

        input[type="button"] {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

            input[type="button"]:hover {
                background-color: #0056b3;
            }

        #messageList {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            list-style-type: none;
            margin: 20px 0;
        }

            #messageList li {
                margin-bottom: 5px;
                padding: 5px;
                background-color: #f8f9fa;
                border-radius: 4px;
            }

        .notification {
            color: #28a745;
            font-style: italic;
        }

        .error {
            color: #dc3545;
            font-weight: bold;
        }

        .connection-status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>SignalR Chat Application</h1>

    <div id="connectionStatus" class="connection-status disconnected">
        Disconnected
    </div>

    <!-- Login Form -->
    <div class="input-group">
        <input type="text" id="loginUsername" placeholder="Username" />
        <input type="password" id="loginPassword" placeholder="Password" />
        <input type="button" id="loginButton" value="Login" />
    </div>

    <div class="input-group">
        <input type="text" id="userInput" placeholder="Enter your name" />
        <span>Current User: <span id="currentUser">Not set</span></span>
    </div>

    <div class="input-group">
        <input type="text" id="messageInput" placeholder="Type your message" />
        <input type="button" id="sendButton" value="Send Message" disabled />
    </div>

    <div class="input-group">
        <input type="text" id="gtxt" placeholder="Group name" />
        <input type="button" id="joinButton" value="Join Group" disabled />
        <input type="button" id="sendGroupButton" value="Send to Group" disabled />
    </div>

    <ul id="messageList"></ul>

    <script>
        let connection;
        let currentUserId = null;
        let isConnected = false;
        let token = localStorage.getItem("jwtToken");

        // DOM elements
        const loginUsername = document.getElementById("loginUsername");
        const loginPassword = document.getElementById("loginPassword");
        const loginButton = document.getElementById("loginButton");
        const userInput = document.getElementById("userInput");
        const messageInput = document.getElementById("messageInput");
        const sendButton = document.getElementById("sendButton");
        const joinButton = document.getElementById("joinButton");
        const sendGroupButton = document.getElementById("sendGroupButton");
        const messageList = document.getElementById("messageList");
        const connectionStatus = document.getElementById("connectionStatus");
        const currentUserSpan = document.getElementById("currentUser");
        const groupInput = document.getElementById("gtxt");

        // Initialize connection
        function initializeConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/chatHub", {
                    accessTokenFactory: () => token
                })
                .withAutomaticReconnect()
                .build();

            connection.on("ReceiveMessage", (name, message) => {
                addMessageToList(`${name}: ${message}`);
            });

            connection.on("ShowWhoJoin", (name, gName) => {
                addMessageToList(`🔔 ${name} joined group (${gName})`, "notification");
            });

            connection.on("ReceiveGroupMessage", (name, gName, message) => {
                addMessageToList(`${name}: ${message}`);
            });

            connection.onclose(() => {
                updateConnectionStatus(false);
                addMessageToList("❌ Connection lost", "error");
            });

            connection.onreconnecting(() => {
                updateConnectionStatus(false);
                addMessageToList("🔄 Reconnecting...", "notification");
            });

            connection.onreconnected(() => {
                updateConnectionStatus(true);
                addMessageToList("✅ Reconnected", "notification");
                if (currentUserId) {
                    registerUser();
                }
            });
        }

        // Start connection
        function startConnection() {
            if (!token) {
                alert("You must login first!");
                return;
            }

            connection.start()
                .then(() => {
                    updateConnectionStatus(true);
                    addMessageToList("✅ Connected to the chat server", "notification");
                    return registerUser();
                })
                .catch(err => {
                    console.error(err.toString());
                    addMessageToList("❌ Connection failed", "error");
                    updateConnectionStatus(false);
                });
        }

        // Register user with server
        function registerUser() {
            if (connection && isConnected) {
                return connection.invoke("RegisterUser")
                    .catch(err => {
                        console.error("RegisterUser failed: ", err);
                        addMessageToList("❌ Registration failed: " + err.message, "error");
                    });
            }
        }

        // Update connection status UI
        function updateConnectionStatus(connected) {
            isConnected = connected;
            connectionStatus.textContent = connected ? "Connected" : "Disconnected";
            connectionStatus.className = `connection-status ${connected ? "connected" : "disconnected"}`;

            sendButton.disabled = !connected;
            joinButton.disabled = !connected;
            sendGroupButton.disabled = !connected;
        }

        // Add message to the list
        function addMessageToList(message, cssClass = "") {
            const li = document.createElement("li");
            li.textContent = message;
            if (cssClass) li.className = cssClass;
            messageList.appendChild(li);
            messageList.scrollTop = messageList.scrollHeight;
        }

        // Event Listeners
        userInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !isConnected) {
                startConnection();
            }
        });

        userInput.addEventListener("blur", () => {
            if (!isConnected && userInput.value.trim()) {
                startConnection();
            }
        });

        messageInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && isConnected) {
                sendMessage();
            }
        });

        sendButton.addEventListener("click", sendMessage);

        joinButton.addEventListener("click", () => {
            const groupName = groupInput.value.trim();
            if (!groupName) {
                alert("Please enter a group name");
                groupInput.focus();
                return;
            }

            connection.invoke("JoinGroup", groupName)
                .then(() => addMessageToList(`📝 You joined group: ${groupName}`, "notification"))
                .catch(err => {
                    console.error("JoinGroup failed: ", err);
                    addMessageToList("❌ Failed to join group: " + err.message, "error");
                });
        });

        sendGroupButton.addEventListener("click", () => {
            const groupName = groupInput.value.trim();
            const message = messageInput.value.trim();

            if (!groupName) {
                alert("Please enter a group name");
                groupInput.focus();
                return;
            }
            if (!message) {
                alert("Please enter a message");
                messageInput.focus();
                return;
            }

            connection.invoke("SendMessageToGroup", groupName, message)
                .then(() => { messageInput.value = ""; })
                .catch(err => {
                    console.error("SendMessageToGroup failed: ", err);
                    addMessageToList("❌ Failed to send group message: " + err.message, "error");
                });
        });

        // Login
        loginButton.addEventListener("click", async () => {
            const username = loginUsername.value.trim();
            const password = loginPassword.value.trim();
            if (!username || !password) {
                alert("Enter username and password");
                return;
            }

            try {
                const response = await fetch("/api/Auth/Login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) {
                    alert("Login failed");
                    return;
                }

                const data = await response.json();
                token = data.token;
                localStorage.setItem("jwtToken", token);
                currentUserId = username;
                currentUserSpan.textContent = username;
                initializeConnection();
                startConnection();
            } catch (err) {
                console.error("Login error: ", err);
                alert("Login request failed");
            }
        });

        // Initialize on page load
        window.addEventListener("load", () => {
            initializeConnection();
            updateConnectionStatus(false);

            const storedUserId = sessionStorage.getItem("userId");
            if (storedUserId) {
                userInput.value = storedUserId;
                currentUserSpan.textContent = storedUserId;
            }

            if (token) startConnection();
            userInput.focus();
        });

        // Save user info on unload
        window.addEventListener("beforeunload", () => {
            if (currentUserId) {
                sessionStorage.setItem("userId", currentUserId);
            }
        });

        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) {
                alert("Please enter a message");
                messageInput.focus();
                return;
            }

            connection.invoke("SendMessage", message)
                .then(() => { messageInput.value = ""; })
                .catch(err => {
                    console.error("SendMessage failed: ", err);
                    addMessageToList("❌ Failed to send message: " + err.message, "error");
                });
        }
    </script>
</body>
</html>
