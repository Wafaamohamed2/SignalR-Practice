<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SignalR Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .input-group {
            margin-bottom: 10px;
        }

        input[type="text"], input[type="password"] {
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 150px;
        }

        input[type="button"] {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        input[type="button"]:hover {
            background-color: #0056b3;
        }

        #messageList {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            list-style-type: none;
            margin: 20px 0;
        }

        #messageList li {
            margin-bottom: 5px;
            padding: 5px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .notification {
            color: #28a745;
            font-style: italic;
        }

        .error {
            color: #dc3545;
            font-weight: bold;
        }

        .connection-status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>SignalR Chat Application</h1>

    <div id="connectionStatus" class="connection-status disconnected">Disconnected</div>

    <!-- Login -->
    <div class="input-group">
        <input type="text" id="loginUsername" placeholder="Username" />
        <input type="password" id="loginPassword" placeholder="Password" />
        <input type="button" id="loginButton" value="Login" />
    </div>

    <div class="input-group">
        Current User: <span id="currentUser">Not set</span>
    </div>

    <!-- Broadcast Message -->
    <div class="input-group">
        <input type="text" id="messageInput" placeholder="Type your message" />
        <input type="button" id="sendButton" value="Send Message" disabled />
    </div>

    <!-- Groups -->
    <div class="input-group">
        <input type="text" id="gtxt" placeholder="Group name" />
        <input type="button" id="joinButton" value="Join Group" disabled />
        <input type="button" id="sendGroupButton" value="Send to Group" disabled />
    </div>

    <!-- Test Notification -->
    <div class="input-group">
        <input type="button" id="testNotificationButton" value="Test Notification" disabled />
    </div>

    <ul id="messageList"></ul>

    <script>
        let connection;
        let currentUserId = null;
        let currentUserName = null;
        let isConnected = false;
        let token = localStorage.getItem("jwtToken");

        // DOM elements
        const loginUsername = document.getElementById("loginUsername");
        const loginPassword = document.getElementById("loginPassword");
        const loginButton = document.getElementById("loginButton");
        const messageInput = document.getElementById("messageInput");
        const sendButton = document.getElementById("sendButton");
        const joinButton = document.getElementById("joinButton");
        const sendGroupButton = document.getElementById("sendGroupButton");
        const testNotificationButton = document.getElementById("testNotificationButton");
        const messageList = document.getElementById("messageList");
        const connectionStatus = document.getElementById("connectionStatus");
        const currentUserSpan = document.getElementById("currentUser");
        const groupInput = document.getElementById("gtxt");

        // Initialize SignalR connection
        async function initializeConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/chatHub", { accessTokenFactory: () => token })
                .withAutomaticReconnect()
                .build();

            connection.on("ReceiveMessage", (name, message) => {
                addMessageToList(`ðŸ’¬ ${name}: ${message}`);
            });

            connection.on("ReceiveGroupMessage", (name, group, message) => {
                addMessageToList(`ðŸ‘¥ [${group}] ${name}: ${message}`);
            });

            connection.on("ReceiveNotification", (title, message) => {
                addMessageToList(`ðŸ”” ${title}: ${message}`, "notification");
            });

            connection.onclose(() => {
                updateConnectionStatus(false);
                addMessageToList("âŒ Connection lost", "error");
            });

            connection.onreconnecting(() => {
                updateConnectionStatus(false);
                addMessageToList("ðŸ”„ Reconnecting...", "notification");
            });

            connection.onreconnected(() => {
                updateConnectionStatus(true);
                addMessageToList("âœ… Reconnected", "notification");
            });

            await connection.start();
            console.log("Connected with ID:", connection.connectionId);
            updateConnectionStatus(true);
        }

        function updateConnectionStatus(connected) {
            isConnected = connected;
            connectionStatus.textContent = connected ? "Connected" : "Disconnected";
            connectionStatus.className = `connection-status ${connected ? "connected" : "disconnected"}`;
            sendButton.disabled = !connected;
            joinButton.disabled = !connected;
            sendGroupButton.disabled = !connected;
            testNotificationButton.disabled = !connected;
        }

        // Send broadcast message
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            try {
                await connection.invoke("SendMessage", message);
                messageInput.value = "";
            } catch (err) {
                console.error("SendMessage failed:", err);
                addMessageToList("âŒ Failed to send: " + err.message, "error");
            }
        }

        // Join group
        async function joinGroup() {
            const groupName = groupInput.value.trim();
            if (!groupName) return;

            try {
                const response = await fetch("/api/Groups/Join", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                    body: JSON.stringify({ groupName })
                });
                const data = await response.json();
                if (response.ok) {
                    addMessageToList("âœ… " + data.message, "notification");
                } else {
                    addMessageToList("âš ï¸ " + data.message, "notification");
                }
            } catch (err) {
                console.error("JoinGroup API failed:", err);
                addMessageToList("âŒ Request failed", "error");
            }
        }

        // Send group message
        async function sendGroupMessage() {
            const groupName = groupInput.value.trim();
            const message = messageInput.value.trim();
            if (!groupName || !message) return;

            try {
                const response = await fetch("/api/Messages/SendToGroup", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                    body: JSON.stringify({ groupName, message })
                });
                const data = await response.json();
                if (response.ok) {
                    addMessageToList("ðŸ“¤ " + data.message, "notification");
                    messageInput.value = "";
                } else {
                    addMessageToList("âŒ Failed: " + data.message, "error");
                }
            } catch (err) {
                console.error("SendToGroup API failed:", err);
                addMessageToList("âŒ Request failed", "error");
            }
        }

        // Test notification
        async function testNotification() {
            if (!currentUserId) { alert("Please login first"); return; }
            try {
                const response = await fetch("/api/Notifications/SendNotification", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                    body: JSON.stringify({
                        userId: currentUserId,
                        title: "Test Notification",
                        notification: "This is a test notification!"
                    })
                });
                const data = await response.json();
                addMessageToList(response.ok ? "ðŸ“¤ " + data.message : "âŒ " + data.message, response.ok ? "notification" : "error");
            } catch (err) {
                console.error("Test notification error:", err);
                addMessageToList("âŒ Failed to send notification", "error");
            }
        }

        function addMessageToList(message, cssClass = "") {
            const li = document.createElement("li");
            li.textContent = message;
            if (cssClass) li.className = cssClass;
            messageList.appendChild(li);
            messageList.scrollTop = messageList.scrollHeight;
        }

        // Login
        loginButton.addEventListener("click", async () => {
            const username = loginUsername.value.trim();
            const password = loginPassword.value.trim();
            if (!username || !password) { alert("Enter username and password"); return; }

            try {
                const response = await fetch("/api/Auth/Login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password })
                });
                const result = await response.json();
                if (!response.ok || !result.token) {
                    alert("Login failed: " + (result.message || response.statusText));
                    return;
                }

                token = result.token;
                localStorage.setItem("jwtToken", token);
                currentUserId = username;
                currentUserSpan.textContent = username;

                await initializeConnection();
                addMessageToList("âœ… Login and connection successful", "notification");
            } catch (err) {
                console.error("Login error: ", err);
                alert("Login request failed: " + err.message);
            }
        });

        // Events
        sendButton.addEventListener("click", sendMessage);
        messageInput.addEventListener("keypress", (e) => { if (e.key === "Enter" && isConnected) sendMessage(); });
        joinButton.addEventListener("click", joinGroup);
        sendGroupButton.addEventListener("click", sendGroupMessage);
        testNotificationButton.addEventListener("click", testNotification);

        window.addEventListener("load", () => { updateConnectionStatus(false); });
    </script>
</body>
</html>
